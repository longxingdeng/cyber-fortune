<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API客户端测试</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            margin-top: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .test-button {
            background: linear-gradient(45deg, #ff006e, #8338ec);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 110, 0.4);
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #4caf50;
        }
        .error {
            border-left: 4px solid #f44336;
        }
        .info {
            border-left: 4px solid #2196f3;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ff006e;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>API客户端测试</h1>
            <p>测试新的API客户端在本地和生产环境下的功能</p>
        </header>

        <div class="test-container">
            <!-- 环境信息 -->
            <div class="test-section">
                <h2>环境信息</h2>
                <div id="environment-info" class="test-result info">
                    正在检测环境...
                </div>
                <button class="test-button" onclick="checkEnvironment()">重新检测环境</button>
            </div>

            <!-- API配置测试 -->
            <div class="test-section">
                <h2>API配置测试</h2>
                <div class="input-group">
                    <label for="api-url">API URL:</label>
                    <input type="text" id="api-url" value="https://api.deepseek.com/v1/chat/completions" placeholder="输入API URL">
                </div>
                <div class="input-group">
                    <label for="api-key">API Key:</label>
                    <input type="password" id="api-key" placeholder="输入API Key">
                </div>
                <div class="input-group">
                    <label for="model-select">模型:</label>
                    <select id="model-select">
                        <option value="deepseek-chat">deepseek-chat</option>
                        <option value="deepseek-coder">deepseek-coder</option>
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4">gpt-4</option>
                    </select>
                </div>
                <button class="test-button" onclick="testConnection()">测试连接</button>
                <button class="test-button" onclick="loadModels()">加载模型列表</button>
                <div id="config-result" class="test-result">
                    等待测试...
                </div>
            </div>

            <!-- API调用测试 -->
            <div class="test-section">
                <h2>API调用测试</h2>
                <div class="input-group">
                    <label for="test-prompt">测试提示:</label>
                    <textarea id="test-prompt" rows="3" placeholder="输入测试提示">请简单介绍一下你自己</textarea>
                </div>
                <button class="test-button" onclick="testNonStreamingAPI()">测试API调用</button>
                <div id="api-result" class="test-result">
                    等待测试...
                </div>
            </div>

            <!-- 配置持久化测试 -->
            <div class="test-section">
                <h2>配置持久化测试</h2>
                <button class="test-button" onclick="saveTestConfig()">保存测试配置</button>
                <button class="test-button" onclick="loadTestConfig()">加载测试配置</button>
                <button class="test-button" onclick="clearTestConfig()">清除测试配置</button>
                <div id="persistence-result" class="test-result">
                    等待测试...
                </div>
            </div>
        </div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="js/config/index.js"></script>
    <script src="js/config/api-client.js"></script>

    <script>
        // 等待配置加载完成
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 等待配置初始化
                if (window.configManager) {
                    await window.configManager.init();
                }
                
                // 检查环境
                checkEnvironment();
                
                // 加载保存的配置
                loadSavedConfig();
            } catch (error) {
                console.error('初始化失败:', error);
                updateResult('environment-info', `初始化失败: ${error.message}`, 'error');
            }
        });

        // 更新结果显示
        function updateResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `test-result ${type}`;
                element.textContent = message;
            }
        }

        // 检查环境
        function checkEnvironment() {
            try {
                const isLocal = window.apiClient ? window.apiClient.isLocalEnvironment() : 
                               window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                const environment = {
                    isLocal: isLocal,
                    hostname: window.location.hostname,
                    port: window.location.port,
                    protocol: window.location.protocol,
                    apiClientAvailable: !!window.apiClient,
                    configManagerAvailable: !!window.configManager
                };

                const info = `环境类型: ${isLocal ? '本地开发环境' : '生产环境'}
主机名: ${environment.hostname}
端口: ${environment.port}
协议: ${environment.protocol}
API客户端: ${environment.apiClientAvailable ? '✅ 可用' : '❌ 不可用'}
配置管理器: ${environment.configManagerAvailable ? '✅ 可用' : '❌ 不可用'}`;

                updateResult('environment-info', info, 'success');
            } catch (error) {
                updateResult('environment-info', `环境检测失败: ${error.message}`, 'error');
            }
        }

        // 加载保存的配置
        function loadSavedConfig() {
            try {
                if (window.configManager) {
                    const config = window.configManager.getConfig();
                    if (config.apiKey) {
                        document.getElementById('api-key').value = config.apiKey;
                    }
                    if (config.customApiUrl) {
                        document.getElementById('api-url').value = config.customApiUrl;
                    }
                    if (config.model) {
                        document.getElementById('model-select').value = config.model;
                    }
                }
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }

        // 测试连接
        async function testConnection() {
            const apiUrl = document.getElementById('api-url').value;
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model-select').value;

            if (!apiUrl || !apiKey) {
                updateResult('config-result', '请填写API URL和API Key', 'error');
                return;
            }

            updateResult('config-result', '正在测试连接...', 'info');

            try {
                const response = await window.apiClient.testConnection(apiUrl, apiKey, model);
                updateResult('config-result', `连接测试成功!\n\n${JSON.stringify(response, null, 2)}`, 'success');
            } catch (error) {
                updateResult('config-result', `连接测试失败: ${error.message}`, 'error');
            }
        }

        // 加载模型列表
        async function loadModels() {
            const apiUrl = document.getElementById('api-url').value;
            const apiKey = document.getElementById('api-key').value;

            if (!apiUrl || !apiKey) {
                updateResult('config-result', '请填写API URL和API Key', 'error');
                return;
            }

            updateResult('config-result', '正在加载模型列表...', 'info');

            try {
                const models = await window.apiClient.loadModels(apiUrl, apiKey);
                const modelSelect = document.getElementById('model-select');
                
                // 清空现有选项
                modelSelect.innerHTML = '';
                
                // 添加新选项
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.id} (${model.owned ? '已拥有' : '未拥有'})`;
                    modelSelect.appendChild(option);
                });

                updateResult('config-result', `成功加载 ${models.length} 个模型:\n\n${JSON.stringify(models, null, 2)}`, 'success');
            } catch (error) {
                updateResult('config-result', `加载模型列表失败: ${error.message}`, 'error');
            }
        }

        // 测试API调用
        async function testNonStreamingAPI() {
            const apiUrl = document.getElementById('api-url').value;
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model-select').value;
            const prompt = document.getElementById('test-prompt').value;

            if (!apiUrl || !apiKey || !prompt) {
                updateResult('api-result', '请填写所有必填字段', 'error');
                return;
            }

            updateResult('api-result', '正在测试API调用...', 'info');

            try {
                const response = await window.apiClient.sendChatRequest({
                    model: model,
                    messages: [{ role: 'user', content: prompt }],
                    stream: false
                }, {
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });

                const result = await response.json();
                const content = result.choices?.[0]?.message?.content || '无响应内容';
                
                updateResult('api-result', `API调用成功!\n\n响应内容:\n${content}`, 'success');
            } catch (error) {
                updateResult('api-result', `API调用失败: ${error.message}`, 'error');
            }
        }

        // 保存测试配置
        function saveTestConfig() {
            try {
                const config = {
                    apiKey: document.getElementById('api-key').value,
                    customApiUrl: document.getElementById('api-url').value,
                    model: document.getElementById('model-select').value
                };

                if (window.configManager) {
                    window.configManager.updateConfig(config);
                    updateResult('persistence-result', '配置保存成功!', 'success');
                } else {
                    updateResult('persistence-result', '配置管理器不可用', 'error');
                }
            } catch (error) {
                updateResult('persistence-result', `配置保存失败: ${error.message}`, 'error');
            }
        }

        // 加载测试配置
        function loadTestConfig() {
            try {
                if (window.configManager) {
                    const config = window.configManager.getConfig();
                    
                    if (config.apiKey) {
                        document.getElementById('api-key').value = config.apiKey;
                    }
                    if (config.customApiUrl) {
                        document.getElementById('api-url').value = config.customApiUrl;
                    }
                    if (config.model) {
                        document.getElementById('model-select').value = config.model;
                    }
                    
                    updateResult('persistence-result', '配置加载成功!', 'success');
                } else {
                    updateResult('persistence-result', '配置管理器不可用', 'error');
                }
            } catch (error) {
                updateResult('persistence-result', `配置加载失败: ${error.message}`, 'error');
            }
        }

        // 清除测试配置
        function clearTestConfig() {
            try {
                document.getElementById('api-key').value = '';
                document.getElementById('api-url').value = 'https://api.deepseek.com/v1/chat/completions';
                document.getElementById('model-select').value = 'deepseek-chat';
                
                if (window.configManager) {
                    window.configManager.clearConfig();
                    updateResult('persistence-result', '配置清除成功!', 'success');
                } else {
                    updateResult('persistence-result', '配置管理器不可用', 'error');
                }
            } catch (error) {
                updateResult('persistence-result', `配置清除失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>