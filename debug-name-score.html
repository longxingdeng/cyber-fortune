<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å§“ååˆ†å€¼è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        th {
            background: #f8f9fa;
        }
        .different {
            background: #ffebee;
            color: #c62828;
        }
        .same {
            background: #e8f5e8;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å§“ååˆ†å€¼è°ƒè¯•å·¥å…·</h1>
        <p>ä¸“é—¨ç”¨äºè°ƒè¯•å§“ååˆ†å€¼è®¡ç®—çš„ä¸€è‡´æ€§é—®é¢˜</p>
        
        <div>
            <label>å§“å: <input type="text" id="testName" value="å¼ ä¼Ÿ" /></label>
            <label>å‡ºç”Ÿå¹´: <input type="number" id="testYear" value="1990" /></label>
            <label>å‡ºç”Ÿæœˆ: <input type="number" id="testMonth" value="5" /></label>
            <label>å‡ºç”Ÿæ—¥: <input type="number" id="testDay" value="15" /></label>
            <label>å‡ºç”Ÿæ—¶: <input type="number" id="testHour" value="10" /></label>
            <button onclick="runDebugTest()">è¿è¡Œè°ƒè¯•æµ‹è¯•</button>
            <button onclick="runBatchTest()">æ‰¹é‡æµ‹è¯•å¤šä¸ªå§“å</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="js/bazi-calculator.js"></script>
    <script src="js/name-calculator.js"></script>
    
    <script>
        function runDebugTest() {
            const resultsDiv = document.getElementById('results');
            const testName = document.getElementById('testName').value;
            const year = parseInt(document.getElementById('testYear').value);
            const month = parseInt(document.getElementById('testMonth').value);
            const day = parseInt(document.getElementById('testDay').value);
            const hour = parseInt(document.getElementById('testHour').value);
            
            resultsDiv.innerHTML = '<div>æ­£åœ¨è¿è¡Œè°ƒè¯•æµ‹è¯•...</div>';
            
            // åˆ›å»ºè®¡ç®—å™¨å®ä¾‹
            const baziCalculator = new BaziCalculator();
            const nameCalculator = new NameCalculator();
            
            const birthData = { year, month, day, hour, gender: 'ç”·' };
            
            // è®¡ç®—å…«å­—ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼Œç¡®ä¿å…«å­—æ•°æ®ä¸€è‡´ï¼‰
            const baziResult = baziCalculator.calculate(birthData);
            
            console.log('å…«å­—ç»“æœ:', baziResult);
            
            // å¤šæ¬¡è¿è¡Œå§“ååˆ†æ
            const iterations = 20;
            const results = [];
            
            for (let i = 0; i < iterations; i++) {
                try {
                    const nameAnalysis = nameCalculator.analyzeName(testName, baziResult);
                    
                    // è·å–ä¸­é—´è®¡ç®—æ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯
                    const surname = testName[0];
                    const firstName = testName.slice(1);
                    const wuGe = nameCalculator.calculateWuGe(surname, firstName);
                    const sanCai = nameCalculator.calculateSanCai(wuGe);
                    const baseScore = nameCalculator.calculateNameScore(wuGe, sanCai);
                    const neededWuXing = nameCalculator.analyzeBaziWuXing(baziResult);
                    const nameWuXing = nameCalculator.getNameWuXing(firstName);
                    const wuXingMatch = nameCalculator.calculateWuXingMatch(neededWuXing, nameWuXing);
                    
                    results.push({
                        iteration: i + 1,
                        finalScore: nameAnalysis.score,
                        wuXingMatch: wuXingMatch,
                        baseScore: baseScore,
                        neededWuXing: neededWuXing.join(','),
                        nameWuXing: JSON.stringify(nameWuXing),
                        tianGe: wuGe.tianGe,
                        renGe: wuGe.renGe,
                        diGe: wuGe.diGe,
                        waiGe: wuGe.waiGe,
                        zongGe: wuGe.zongGe,
                        sanCaiCode: sanCai.sanCaiCode,
                        jiXiong: sanCai.jiXiong
                    });
                } catch (error) {
                    results.push({
                        iteration: i + 1,
                        error: error.message
                    });
                }
            }
            
            // åˆ†æç»“æœ
            const firstResult = results[0];
            let hasInconsistency = false;
            const inconsistentFields = new Set();
            
            for (let i = 1; i < results.length; i++) {
                const current = results[i];
                if (current.error) continue;
                
                Object.keys(firstResult).forEach(key => {
                    if (key !== 'iteration' && firstResult[key] !== current[key]) {
                        hasInconsistency = true;
                        inconsistentFields.add(key);
                    }
                });
            }
            
            // ç”Ÿæˆç»“æœè¡¨æ ¼
            let html = `<h3>æµ‹è¯•ç»“æœ (${testName})</h3>`;
            
            if (hasInconsistency) {
                html += `<div style="color: red; font-weight: bold;">âŒ å‘ç°ä¸ä¸€è‡´ï¼ä¸ä¸€è‡´å­—æ®µ: ${Array.from(inconsistentFields).join(', ')}</div>`;
            } else {
                html += `<div style="color: green; font-weight: bold;">âœ… æ‰€æœ‰${iterations}æ¬¡è®¡ç®—ç»“æœä¸€è‡´</div>`;
            }
            
            html += '<table><tr>';
            html += '<th>æ¬¡æ•°</th><th>æœ€ç»ˆåˆ†æ•°</th><th>äº”è¡ŒåŒ¹é…</th><th>åŸºç¡€åˆ†æ•°</th><th>éœ€è¦äº”è¡Œ</th><th>å§“åäº”è¡Œ</th>';
            html += '<th>å¤©æ ¼</th><th>äººæ ¼</th><th>åœ°æ ¼</th><th>å¤–æ ¼</th><th>æ€»æ ¼</th><th>ä¸‰æ‰</th><th>å‰å‡¶</th>';
            html += '</tr>';
            
            results.forEach(result => {
                if (result.error) {
                    html += `<tr><td>${result.iteration}</td><td colspan="12" style="color: red;">é”™è¯¯: ${result.error}</td></tr>`;
                    return;
                }
                
                html += '<tr>';
                Object.keys(result).forEach(key => {
                    if (key === 'iteration') {
                        html += `<td>${result[key]}</td>`;
                    } else {
                        const isDifferent = inconsistentFields.has(key);
                        const className = isDifferent ? 'different' : 'same';
                        html += `<td class="${className}">${result[key]}</td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
            html += `<h4>å…«å­—ä¿¡æ¯</h4>`;
            html += `<p>å¹´æŸ±: ${baziResult.yearPillar}, æœˆæŸ±: ${baziResult.monthPillar}, æ—¥æŸ±: ${baziResult.dayPillar}, æ—¶æŸ±: ${baziResult.hourPillar}</p>`;
            html += `<p>æ—¥ä¸»: ${baziResult.dayTianGan}</p>`;
            
            resultsDiv.innerHTML = html;
        }
        
        function runBatchTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div>æ­£åœ¨è¿è¡Œæ‰¹é‡æµ‹è¯•...</div>';

            // åˆ›å»ºè®¡ç®—å™¨å®ä¾‹
            const baziCalculator = new BaziCalculator();
            const nameCalculator = new NameCalculator();

            // æµ‹è¯•æ•°æ®
            const testCases = [
                { name: 'å¼ ä¼Ÿ', birthData: { year: 1990, month: 5, day: 15, hour: 10, gender: 'ç”·' } },
                { name: 'æå¨œ', birthData: { year: 1985, month: 8, day: 20, hour: 14, gender: 'å¥³' } },
                { name: 'ç‹å°æ˜', birthData: { year: 1995, month: 3, day: 10, hour: 8, gender: 'ç”·' } },
                { name: 'é™ˆç¾ä¸½', birthData: { year: 1988, month: 12, day: 25, hour: 16, gender: 'å¥³' } },
                { name: 'åˆ˜å¼º', birthData: { year: 1992, month: 7, day: 8, hour: 9, gender: 'ç”·' } }
            ];

            let html = '<h3>æ‰¹é‡ä¸€è‡´æ€§æµ‹è¯•ç»“æœ</h3>';
            let allTestsPassed = true;

            testCases.forEach((testCase, caseIndex) => {
                try {
                    // è®¡ç®—å…«å­—ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼‰
                    const baziResult = baziCalculator.calculate(testCase.birthData);

                    // å¤šæ¬¡è¿è¡Œå§“ååˆ†æ
                    const iterations = 20;
                    const results = [];

                    for (let i = 0; i < iterations; i++) {
                        const nameAnalysis = nameCalculator.analyzeName(testCase.name, baziResult);
                        results.push({
                            score: nameAnalysis.score,
                            wuXingMatch: nameAnalysis.wuXingMatch,
                            serialized: JSON.stringify(nameAnalysis)
                        });
                    }

                    // æ£€æŸ¥ä¸€è‡´æ€§
                    const firstResult = results[0];
                    let isConsistent = true;
                    const inconsistentFields = [];

                    for (let i = 1; i < results.length; i++) {
                        if (results[i].score !== firstResult.score) {
                            isConsistent = false;
                            inconsistentFields.push(`åˆ†æ•°: ${firstResult.score} vs ${results[i].score}`);
                            break;
                        }
                        if (results[i].wuXingMatch !== firstResult.wuXingMatch) {
                            isConsistent = false;
                            inconsistentFields.push(`äº”è¡ŒåŒ¹é…: ${firstResult.wuXingMatch} vs ${results[i].wuXingMatch}`);
                            break;
                        }
                        if (results[i].serialized !== firstResult.serialized) {
                            isConsistent = false;
                            inconsistentFields.push('å®Œæ•´ç»“æœä¸ä¸€è‡´');
                            break;
                        }
                    }

                    if (isConsistent) {
                        html += `<div style="color: green; margin: 10px 0;">
                            âœ… ${testCase.name}: é€šè¿‡ - æ‰€æœ‰${iterations}æ¬¡è®¡ç®—ç»“æœä¸€è‡´ (åˆ†æ•°: ${firstResult.score}åˆ†, äº”è¡ŒåŒ¹é…: ${firstResult.wuXingMatch}åˆ†)
                        </div>`;
                    } else {
                        html += `<div style="color: red; margin: 10px 0;">
                            âŒ ${testCase.name}: å¤±è´¥ - è®¡ç®—ç»“æœä¸ä¸€è‡´<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;ä¸ä¸€è‡´å­—æ®µ: ${inconsistentFields.join(', ')}
                        </div>`;
                        allTestsPassed = false;
                    }

                } catch (error) {
                    html += `<div style="color: red; margin: 10px 0;">
                        âŒ ${testCase.name}: é”™è¯¯ - ${error.message}
                    </div>`;
                    allTestsPassed = false;
                }
            });

            // æ€»ç»“
            if (allTestsPassed) {
                html += `<div style="color: green; font-weight: bold; margin: 20px 0; padding: 10px; background: #e8f5e8; border-radius: 4px;">
                    ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å§“ååˆ†å€¼è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´ã€‚
                </div>`;
            } else {
                html += `<div style="color: red; font-weight: bold; margin: 20px 0; padding: 10px; background: #ffebee; border-radius: 4px;">
                    âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œå­˜åœ¨è®¡ç®—ç»“æœä¸ä¸€è‡´çš„é—®é¢˜ã€‚
                </div>`;
            }

            resultsDiv.innerHTML = html;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
