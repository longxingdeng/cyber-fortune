<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合婚AI分析简单测试</title>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #00d4ff;
            color: #000;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background: #00ffff;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .result {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        .error {
            background: #4a1a1a;
            border-left-color: #ff4444;
        }
        .processing {
            text-align: center;
            padding: 20px;
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 合婚AI分析样式 */
        .ai-marriage-output {
            background: linear-gradient(135deg, rgba(255, 0, 128, 0.05), rgba(0, 212, 255, 0.05));
            border: 1px solid rgba(255, 0, 128, 0.2);
            border-radius: 8px;
            padding: 1.5rem;
            color: #fff;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.95rem;
        }

        .ai-marriage-output h1,
        .ai-marriage-output h2,
        .ai-marriage-output h3,
        .ai-marriage-output h4 {
            color: #00d4ff;
            margin: 1rem 0 0.6rem 0;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .ai-marriage-output h1 {
            font-size: 1.6rem;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 0.5rem;
            text-align: center;
            margin: 0 0 1rem 0;
        }

        .ai-marriage-output h2 {
            font-size: 1.4rem;
            border-left: 4px solid #00ff88;
            padding-left: 1rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
            margin: 1.2rem 0 0.8rem 0;
        }

        .ai-marriage-output h3 {
            font-size: 1.2rem;
            color: #00ff88;
            margin: 0.8rem 0 0.5rem 0;
        }

        .ai-marriage-output h4 {
            font-size: 1.1rem;
            color: #ff0080;
            margin: 0.6rem 0 0.4rem 0;
        }

        .ai-marriage-output strong {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }

        .ai-marriage-output em {
            color: #ff0080;
            font-style: italic;
            text-shadow: 0 0 5px rgba(255, 0, 128, 0.3);
        }

        .ai-marriage-output .highlight {
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.2), transparent);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            border-left: 2px solid #00ff88;
            font-weight: bold;
            color: #00ff88;
        }

        .ai-marriage-output .suggestion-box {
            background: rgba(255, 0, 128, 0.1);
            border: 1px solid rgba(255, 0, 128, 0.3);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.6rem 0;
        }

        .ai-marriage-output .warning-box {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 6px;
            padding: 0.6rem;
            margin: 0.5rem 0;
            color: #ffa500;
            border-left: 4px solid #ffa500;
        }

        .ai-marriage-output .success-box {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 6px;
            padding: 0.6rem;
            margin: 0.5rem 0;
            color: #00ff88;
            border-left: 4px solid #00ff88;
        }
    </style>
</head>
<body>
    <div class="test-section">
        <h1>🤖 合婚AI分析简单测试</h1>
        <p>这是一个简化的测试页面，用于验证合婚AI分析功能</p>
        
        <h3>步骤1: 配置AI设置</h3>
        <button onclick="configureAI()">配置AI设置</button>
        <button onclick="checkConfig()">检查当前配置</button>
        
        <h3>步骤2: 测试AI分析</h3>
        <button onclick="testMarriageAI()" id="testBtn">测试合婚AI分析</button>
        <button onclick="clearResults()">清除结果</button>
    </div>

    <div id="results"></div>

    <script>
        // 配置AI设置
        function configureAI() {
            const apiUrl = prompt('请输入API地址:', 'https://api.openai.com/v1/chat/completions');
            const apiKey = prompt('请输入API密钥:', '');
            const model = prompt('请输入模型名称:', 'gpt-3.5-turbo');
            
            if (apiUrl && apiKey && model) {
                const config = { apiUrl, apiKey, model };
                localStorage.setItem('cyberFortune_globalConfig', JSON.stringify(config));
                showResult('AI配置已保存: ' + JSON.stringify(config, null, 2), 'success');
            }
        }

        // 检查当前配置
        function checkConfig() {
            const config = localStorage.getItem('cyberFortune_globalConfig');
            if (config) {
                const parsed = JSON.parse(config);
                // 隐藏API密钥的部分字符
                const safeConfig = {
                    ...parsed,
                    apiKey: parsed.apiKey ? parsed.apiKey.substring(0, 10) + '...' : ''
                };
                showResult('当前AI配置: ' + JSON.stringify(safeConfig, null, 2), 'success');
            } else {
                showResult('未找到AI配置', 'error');
            }
        }

        // 测试合婚AI分析
        async function testMarriageAI() {
            const config = localStorage.getItem('cyberFortune_globalConfig');
            if (!config) {
                showResult('请先配置AI设置', 'error');
                return;
            }

            const { apiUrl, apiKey, model } = JSON.parse(config);
            
            // 模拟合婚数据
            const testPrompt = `你是一位精通中国传统合婚理论的专家。请分析以下合婚信息：

【男方信息】
姓名：张三
出生时间：1990年5月15日 08:00
生肖：马

【女方信息】
姓名：李四
出生时间：1992年8月20日 14:30
生肖：猴

【基础合婚分析结果】
综合匹配度：75分 (比较匹配)
生肖配对：70分
五行配对：80分

请提供详细的合婚分析建议。`;

            showProcessing();
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: "system",
                                content: "你是精通中国传统合婚理论的专家。"
                            },
                            {
                                role: "user",
                                content: testPrompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API错误 (${response.status}): ${errorData.error?.message || '未知错误'}`);
                }

                const data = await response.json();
                const result = data.choices?.[0]?.message?.content || '未获取到分析结果';
                
                showResult('AI分析结果:\n\n' + result, 'success');
                
            } catch (error) {
                console.error('AI分析失败:', error);
                showResult('AI分析失败: ' + error.message, 'error');
            }
        }

        // 显示处理状态
        function showProcessing() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="result processing">
                    <div class="loader"></div>
                    <p>正在进行AI分析，请稍候...</p>
                </div>
            `;
            
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '分析中...';
        }

        // 显示结果
        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');

            if (type === 'error') {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <pre>${message}</pre>
                    </div>
                `;
            } else {
                // 使用合婚AI的格式化函数
                const formatted = formatMarriageAIResponse(message);
                resultsDiv.innerHTML = `
                    <div class="result">
                        <div class="ai-marriage-output">
                            ${formatted}
                        </div>
                    </div>
                `;
            }

            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = false;
            testBtn.textContent = '测试合婚AI分析';
        }

        // 简化版的格式化函数
        function formatMarriageAIResponse(text) {
            if (!text) return '<div class="ai-response-streaming">正在生成分析...</div>';

            let formatted = text;

            // 处理标题层级
            formatted = formatted
                .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/^#### (.*?)$/gm, '<h4>$1</h4>');

            // 处理粗体和斜体
            formatted = formatted
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 处理特殊标记
            formatted = formatted
                .replace(/【(.*?)】/g, '<span class="highlight">【$1】</span>')
                .replace(/💡\s*(.*?)$/gm, '<div class="suggestion-box">💡 $1</div>')
                .replace(/⚠️\s*(.*?)$/gm, '<div class="warning-box">⚠️ $1</div>')
                .replace(/✅\s*(.*?)$/gm, '<div class="success-box">✅ $1</div>');

            // 处理段落
            formatted = formatted.replace(/\n\n/g, '</p><p>');
            if (!formatted.includes('<p>')) {
                formatted = '<p>' + formatted + '</p>';
            }

            return formatted;
        }

        // 清除结果
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
