<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台湾省完整数据测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-section {
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .city-card {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
        }
        .city-name {
            font-size: 18px;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 10px;
        }
        .city-info {
            font-size: 14px;
            color: #ffffff;
            margin: 5px 0;
        }
        .longitude {
            font-family: 'Courier New', monospace;
            color: #ffc107;
        }
        .correction {
            font-family: 'Courier New', monospace;
            color: #28a745;
        }
        .correction.negative {
            color: #dc3545;
        }
        button {
            background: #00ffff;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00cccc;
        }
        .stats {
            background: rgba(0, 255, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 10px;
            text-align: center;
        }
        .comparison-table th {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
        }
    </style>
</head>
<body>
    <h1>台湾省完整数据测试验证</h1>
    
    <div class="test-section">
        <h2>测试控制面板</h2>
        <button onclick="showTaiwanCities()">显示台湾城市</button>
        <button onclick="testTrueSolarTime()">测试真太阳时修正</button>
        <button onclick="testBaziCalculation()">测试八字计算</button>
        <button onclick="validateDataConsistency()">验证数据一致性</button>
    </div>

    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/lunisolar@2.5.1/dist/lunisolar.min.js"></script>
    <script src="js/bazi-calculator.js"></script>
    <script src="js/main.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        let calculator;
        let mainApp;

        function addResult(title, content) {
            const div = document.createElement('div');
            div.className = 'test-section';
            div.innerHTML = `
                <h3>${title}</h3>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(div);
        }

        function showTaiwanCities() {
            resultsDiv.innerHTML = '';
            
            if (!calculator) {
                calculator = new BaziCalculator();
            }

            const taiwanData = calculator.locationData["台湾省"];
            if (!taiwanData) {
                addResult('错误', '未找到台湾省数据');
                return;
            }

            const cities = Object.keys(taiwanData);
            const longitudes = cities.map(city => taiwanData[city].longitude);
            const avgLongitude = longitudes.reduce((a, b) => a + b, 0) / longitudes.length;

            let content = `
                <div class="stats">
                    <h4>台湾省数据概览</h4>
                    <p><strong>城市数量：</strong>${cities.length}个</p>
                    <p><strong>经度范围：</strong>${Math.min(...longitudes).toFixed(1)}°E - ${Math.max(...longitudes).toFixed(1)}°E</p>
                    <p><strong>平均经度：</strong>${avgLongitude.toFixed(1)}°E</p>
                    <p><strong>与标准时间差异：</strong>${((avgLongitude - 120.0) * 4).toFixed(1)}分钟</p>
                </div>
                <div class="city-grid">
            `;

            cities.forEach(city => {
                const longitude = taiwanData[city].longitude;
                const correction = (longitude - 120.0) * 4;
                
                content += `
                    <div class="city-card">
                        <div class="city-name">${city}</div>
                        <div class="city-info">经度: <span class="longitude">${longitude}°E</span></div>
                        <div class="city-info">修正: <span class="correction ${correction < 0 ? 'negative' : ''}">${correction >= 0 ? '+' : ''}${correction.toFixed(1)}分钟</span></div>
                    </div>
                `;
            });

            content += '</div>';
            addResult('台湾省城市数据', content);
        }

        function testTrueSolarTime() {
            if (!calculator) {
                calculator = new BaziCalculator();
            }

            const taiwanData = calculator.locationData["台湾省"];
            const testTime = { year: 2024, month: 6, day: 15, hour: 12, minute: 0 };
            
            let content = `
                <p>测试时间：${testTime.year}年${testTime.month}月${testTime.day}日 ${testTime.hour}:${testTime.minute.toString().padStart(2, '0')}</p>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>城市</th>
                            <th>经度</th>
                            <th>原始时间</th>
                            <th>修正时间</th>
                            <th>经度修正</th>
                            <th>时间方程</th>
                            <th>总修正</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(taiwanData).forEach(city => {
                const longitude = taiwanData[city].longitude;
                const trueSolarTime = calculator.calculateTrueSolarTime(
                    testTime.year, testTime.month, testTime.day, 
                    testTime.hour, testTime.minute, longitude
                );
                
                content += `
                    <tr>
                        <td>${city}</td>
                        <td>${longitude}°E</td>
                        <td>${trueSolarTime.originalTime}</td>
                        <td>${trueSolarTime.correctedTime}</td>
                        <td>${trueSolarTime.longitudeCorrection >= 0 ? '+' : ''}${trueSolarTime.longitudeCorrection.toFixed(1)}分</td>
                        <td>${trueSolarTime.timeEquation >= 0 ? '+' : ''}${trueSolarTime.timeEquation.toFixed(1)}分</td>
                        <td>${trueSolarTime.correction >= 0 ? '+' : ''}${trueSolarTime.correction.toFixed(1)}分</td>
                    </tr>
                `;
            });

            content += '</tbody></table>';
            addResult('台湾真太阳时修正测试', content);
        }

        function testBaziCalculation() {
            if (!calculator) {
                calculator = new BaziCalculator();
            }

            const taiwanCities = Object.keys(calculator.locationData["台湾省"]);
            const testData = {
                year: 1990,
                month: 6,
                day: 15,
                hour: 14,
                minute: 30,
                gender: '男'
            };

            let content = `
                <p>测试八字计算：${testData.year}年${testData.month}月${testData.day}日 ${testData.hour}:${testData.minute.toString().padStart(2, '0')} ${testData.gender}</p>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>城市</th>
                            <th>修正时间</th>
                            <th>八字</th>
                            <th>计算方法</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            taiwanCities.forEach(city => {
                try {
                    const birthData = {
                        ...testData,
                        birthProvince: '台湾省',
                        birthCity: city
                    };
                    
                    const result = calculator.calculate(birthData);
                    const correctedTime = result.trueSolarTimeInfo ? result.trueSolarTimeInfo.correctedTime : '未修正';
                    
                    content += `
                        <tr>
                            <td>${city}</td>
                            <td>${correctedTime}</td>
                            <td>${result.fullBazi}</td>
                            <td>${result.calculationMethod}</td>
                        </tr>
                    `;
                } catch (error) {
                    content += `
                        <tr>
                            <td>${city}</td>
                            <td colspan="3" style="color: #dc3545;">计算失败: ${error.message}</td>
                        </tr>
                    `;
                }
            });

            content += '</tbody></table>';
            addResult('台湾八字计算测试', content);
        }

        function validateDataConsistency() {
            if (!calculator) {
                calculator = new BaziCalculator();
            }
            if (!mainApp) {
                mainApp = new CyberFortuneApp();
            }

            const taiwanCities = mainApp.getCitiesForProvince('台湾省');
            const calculatorCities = Object.keys(calculator.locationData["台湾省"] || {});

            let content = `
                <div class="stats">
                    <h4>数据一致性验证</h4>
                    <p><strong>八字计算器中的城市：</strong>${calculatorCities.length}个</p>
                    <p><strong>主应用中的城市：</strong>${taiwanCities.length}个</p>
                    <p><strong>数据一致性：</strong>${calculatorCities.length === taiwanCities.length ? '✅ 一致' : '❌ 不一致'}</p>
                </div>
                
                <h4>城市列表对比</h4>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>八字计算器</th>
                            <th>主应用</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const maxLength = Math.max(calculatorCities.length, taiwanCities.length);
            for (let i = 0; i < maxLength; i++) {
                const calcCity = calculatorCities[i] || '';
                const mainCity = taiwanCities[i] || '';
                const isMatch = calcCity === mainCity;
                
                content += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${calcCity}</td>
                        <td>${mainCity}</td>
                        <td>${isMatch ? '✅' : '❌'}</td>
                    </tr>
                `;
            }

            content += '</tbody></table>';
            addResult('数据一致性验证', content);
        }

        // 页面加载时初始化
        window.onload = function() {
            calculator = new BaziCalculator();
            mainApp = new CyberFortuneApp();
            addResult('系统初始化', '台湾省完整数据测试页面已加载，所有测试功能可用');
            showTaiwanCities();
        };
    </script>
</body>
</html>
